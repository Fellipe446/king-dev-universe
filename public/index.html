<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KING DEV UNIVERSE | V5.0 FINAL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; }
        .bg-grid { background-image: radial-gradient(#cbd5e1 1px, transparent 1px); background-size: 20px 20px; }
        .scratch-block { padding: 12px; margin-bottom: 8px; border-radius: 8px 24px 24px 8px; color: white; font-weight: bold; font-size: 11px; cursor: pointer; border-left: 10px solid rgba(0,0,0,0.2); transition: 0.3s; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .scratch-block:hover { transform: translateX(8px); filter: brightness(1.1); }
        .element-selected { outline: 3px solid #4c97ff; outline-offset: 4px; z-index: 999 !important; }
        #canvas { transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        .logic-panel { background: #fffbeb; border: 1px solid #fde68a; padding: 12px; border-radius: 12px; margin-top: 15px; }
    </style>
</head>
<body class="bg-[#f1f5f9] h-screen flex flex-col overflow-hidden">

    <header class="h-14 bg-[#4c97ff] flex items-center px-6 justify-between text-white shadow-2xl z-[1000]">
        <div class="flex items-center gap-3">
            <div class="bg-white p-1 rounded-lg"><i data-lucide="crown" class="text-[#4c97ff] w-5 h-5"></i></div>
            <span class="font-black tracking-tighter text-lg uppercase">King Dev Academy</span>
        </div>
        <div class="flex items-center gap-4">
            <div class="flex bg-white/10 rounded-full p-1 gap-1">
                <button onclick="resize('mobile')" class="p-2 hover:bg-white/20 rounded-full"><i data-lucide="smartphone" class="w-4 h-4"></i></button>
                <button onclick="resize('desktop')" class="p-2 hover:bg-white/20 rounded-full"><i data-lucide="monitor" class="w-4 h-4"></i></button>
            </div>
            <button onclick="saveOnRender()" class="bg-emerald-500 hover:bg-emerald-600 px-6 py-2 rounded-full text-xs font-black shadow-lg transition-all active:scale-95 uppercase">Salvar na Nuvem</button>
        </div>
    </header>

    <main class="flex flex-1 overflow-hidden">
        <aside class="w-72 bg-white border-r border-gray-200 shadow-xl flex flex-col z-50">
            <div class="p-4 bg-slate-50 border-b font-black text-[10px] text-slate-400 tracking-widest uppercase italic">Componentes Scratch</div>
            <div class="p-4 flex-1 overflow-y-auto space-y-6">
                <section>
                    <h4 class="text-blue-500 font-black text-[10px] mb-3 uppercase flex items-center gap-2"><i data-lucide="layout" class="w-3 h-3"></i> Estrutura</h4>
                    <div class="scratch-block bg-[#4c97ff]" onclick="addElement('h1')">Título Grande</div>
                    <div class="scratch-block bg-[#4c97ff]" onclick="addElement('p')">Parágrafo de Texto</div>
                    <div class="scratch-block bg-[#4c97ff]" onclick="addElement('button')">Botão King CTA</div>
                </section>
                <section>
                    <h4 class="text-purple-500 font-black text-[10px] mb-3 uppercase flex items-center gap-2"><i data-lucide="zap" class="w-3 h-3"></i> Mídia e IA</h4>
                    <div class="scratch-block bg-[#9966ff]" onclick="addElement('img')">Imagem Via URL</div>
                    <div class="scratch-block bg-[#9966ff]" onclick="addElement('video')">Vídeo YouTube</div>
                </section>
            </div>
            <div class="p-4 border-t bg-slate-50">
                <h4 class="text-[10px] font-black text-slate-400 uppercase mb-2">Camadas (Layers)</h4>
                <div id="layer-list" class="space-y-1 max-h-48 overflow-y-auto text-[10px] font-bold"></div>
            </div>
        </aside>

        <section class="flex-1 bg-slate-200 relative overflow-auto flex items-center justify-center bg-grid p-6">
            <div id="canvas" class="bg-white w-[375px] h-[812px] rounded-[40px] shadow-[0_0_80px_rgba(0,0,0,0.15)] relative border-[10px] border-slate-900 overflow-hidden">
                </div>
        </section>

        <aside class="w-80 bg-white border-l border-gray-200 p-6 z-50 overflow-y-auto">
            <div id="inspector-ui" class="hidden space-y-6">
                <h3 class="font-black text-slate-800 text-sm border-b pb-4 uppercase tracking-tighter">Propriedades</h3>
                
                <div class="space-y-4">
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase">Texto / Conteúdo</label>
                        <input type="text" id="prop-text" oninput="update()" class="w-full bg-slate-50 border rounded-lg p-2.5 text-sm outline-none focus:ring-2 ring-blue-400">
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-[10px] font-black text-slate-400 uppercase">Fundo</label>
                            <input type="color" id="prop-bg" oninput="update()" class="w-full h-10 rounded-lg cursor-pointer border-none shadow-sm">
                        </div>
                        <div>
                            <label class="text-[10px] font-black text-slate-400 uppercase">Cor Texto</label>
                            <input type="color" id="prop-color" oninput="update()" class="w-full h-10 rounded-lg cursor-pointer border-none shadow-sm">
                        </div>
                    </div>

                    <div class="logic-panel">
                        <label class="text-[10px] font-black text-amber-600 uppercase flex items-center gap-1"><i data-lucide="play" class="w-3 h-3"></i> Ao Clicar (Lógica):</label>
                        <select id="prop-action" onchange="update()" class="w-full mt-2 bg-white border rounded p-2 text-[11px] font-bold">
                            <option value="none">Nenhuma ação</option>
                            <option value="link">Abrir URL Externa</option>
                            <option value="alert">Mostrar Mensagem</option>
                        </select>
                        <input type="text" id="prop-action-val" oninput="update()" placeholder="URL ou Texto..." class="w-full mt-2 border rounded p-2 text-[11px]">
                    </div>

                    <div class="pt-4 border-t flex gap-2">
                        <button onclick="changeZ('down')" class="flex-1 bg-slate-100 p-3 rounded-xl hover:bg-slate-200 transition-all"><i data-lucide="move-down" class="w-4 h-4 mx-auto text-slate-600"></i></button>
                        <button onclick="changeZ('up')" class="flex-1 bg-slate-100 p-3 rounded-xl hover:bg-slate-200 transition-all"><i data-lucide="move-up" class="w-4 h-4 mx-auto text-slate-600"></i></button>
                        <button onclick="removeElement()" class="flex-1 bg-red-50 p-3 rounded-xl hover:bg-red-500 hover:text-white transition-all"><i data-lucide="trash-2" class="w-4 h-4 mx-auto"></i></button>
                    </div>
                </div>
            </div>
            <div id="no-sel" class="flex flex-col items-center justify-center h-full opacity-20 text-center">
                <i data-lucide="mouse-pointer-2" class="w-12 h-12 mb-4"></i>
                <p class="text-xs font-black uppercase tracking-widest">Selecione para editar</p>
            </div>
        </aside>
    </main>

    <script>
        lucide.createIcons();
        let project = { elements: [], selectedId: null };

        function addElement(type) {
            const el = {
                id: 'king-' + Date.now(),
                type: type,
                name: type.toUpperCase() + ' ' + (project.elements.length + 1),
                text: type === 'img' ? 'https://via.placeholder.com/300' : (type === 'h1' ? 'Título King' : 'Clique aqui'),
                x: 37, y: 150, w: 300, h: type === 'video' ? 170 : 60,
                bg: type === 'button' ? '#4c97ff' : (type === 'h1' ? 'transparent' : '#f1f5f9'),
                color: type === 'button' ? '#ffffff' : '#0f172a',
                zIndex: 10,
                action: 'none', actionVal: ''
            };
            project.elements.push(el);
            render();
            select(el.id);
        }

        function render() {
            const canvas = document.getElementById('canvas');
            const layerList = document.getElementById('layer-list');
            canvas.innerHTML = '';
            layerList.innerHTML = '';

            project.elements.sort((a, b) => a.zIndex - b.zIndex).forEach(el => {
                let dom;
                if(el.type === 'img') {
                    dom = document.createElement('img');
                    dom.src = el.text;
                    dom.style.objectFit = 'cover';
                } else if(el.type === 'video') {
                    dom = document.createElement('div');
                    dom.innerHTML = `<iframe class="w-full h-full pointer-events-none" src="${el.text.replace('watch?v=', 'embed/')}"></iframe>`;
                    dom.style.background = '#000';
                } else {
                    dom = document.createElement(el.type === 'button' ? 'button' : (el.type === 'h1' ? 'h1' : 'div'));
                    dom.innerText = el.text;
                    if(el.type === 'h1') dom.style.fontSize = '24px';
                }

                dom.id = el.id;
                dom.className = `absolute flex items-center justify-center transition-shadow cursor-move font-black ${project.selectedId === el.id ? 'element-selected shadow-2xl' : 'shadow-md'}`;
                dom.style.cssText += `left:${el.x}px; top:${el.y}px; width:${el.w}px; height:${el.h}px; background:${el.bg}; color:${el.color}; border-radius:12px; z-index:${el.zIndex}; border:none;`;

                dom.onmousedown = (e) => {
                    select(el.id);
                    let rect = canvas.getBoundingClientRect();
                    let ox = e.clientX - rect.left - el.x;
                    let oy = e.clientY - rect.top - el.y;
                    document.onmousemove = (ev) => {
                        el.x = Math.round((ev.clientX - rect.left - ox) / 10) * 10;
                        el.y = Math.round((ev.clientY - rect.top - oy) / 10) * 10;
                        render();
                    };
                    document.onmouseup = () => document.onmousemove = null;
                };
                canvas.appendChild(dom);

                // Camadas (Layers)
                const li = document.createElement('div');
                li.className = `p-2 rounded mb-1 flex justify-between cursor-pointer ${project.selectedId === el.id ? 'bg-blue-500 text-white' : 'bg-white border hover:bg-slate-50'}`;
                li.innerHTML = `<span>${el.name}</span> <i data-lucide="layers" class="w-3 h-3 opacity-50"></i>`;
                li.onclick = () => select(el.id);
                layerList.prepend(li);
            });
            lucide.createIcons();
        }

        function select(id) {
            project.selectedId = id;
            const el = project.elements.find(e => e.id === id);
            document.getElementById('no-sel').classList.add('hidden');
            document.getElementById('inspector-ui').classList.remove('hidden');
            document.getElementById('prop-text').value = el.text;
            document.getElementById('prop-bg').value = el.bg;
            document.getElementById('prop-color').value = el.color;
            document.getElementById('prop-action').value = el.action;
            document.getElementById('prop-action-val').value = el.actionVal;
            render();
        }

        function update() {
            const el = project.elements.find(e => e.id === project.selectedId);
            el.text = document.getElementById('prop-text').value;
            el.bg = document.getElementById('prop-bg').value;
            el.color = document.getElementById('prop-color').value;
            el.action = document.getElementById('prop-action').value;
            el.actionVal = document.getElementById('prop-action-val').value;
            render();
        }

        function changeZ(dir) {
            const el = project.elements.find(e => e.id === project.selectedId);
            el.zIndex += (dir === 'up' ? 1 : -1);
            render();
        }

        function removeElement() {
            project.elements = project.elements.filter(e => e.id !== project.selectedId);
            project.selectedId = null;
            document.getElementById('inspector-ui').classList.add('hidden');
            document.getElementById('no-sel').classList.remove('hidden');
            render();
        }

        function resize(mode) {
            const c = document.getElementById('canvas');
            if(mode === 'mobile') { c.style.width = '375px'; c.style.height = '812px'; c.style.borderRadius = '40px'; }
            else { c.style.width = '90%'; c.style.height = '90%'; c.style.borderRadius = '10px'; }
        }

        async function saveOnRender() {
            try {
                await fetch('/api/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(project)
                });
                alert("✅ King Dev Academy: Projeto Salvo na Nuvem!");
            } catch (e) { alert("❌ Erro ao salvar."); }
        }
    </script>
</body>
</html>
